= 仮想マシンの管理

== はじめに

このラボの最初のセクションでは、OpenShift Virtualization における VM の作成と管理の基本について紹介します。事前に定義されたテンプレートから仮想マシンを作成するプロセス全体を通して、Web コンソールがどのようにあなたをガイドするかを見ていきます。その後、仮想マシンのプロパティを確認し、基本的なカスタマイズを行い、仮想マシン管理者に期待されるライブマイグレーションなどのアクションを実行します。

.*目標*

* 新規仮想マシンの作成
* 仮想マシンのリソースの確認と変更
* OpenShift コンソールを使用して VM の電源状態がどのように管理されるかを理解する。
* 2つのホスト間でVMをライブマイグレートする

== OpenShift コンソールへのログイン
OpenShift コンソールのログイン情報は、ラボ環境を払い出した際に表示されたページで確認できます。

- username: kubeadmin
- password: ラボ環境で表示されているもの

[[create_project]]
== 新規プロジェクトの作成

OpenShiftの他のオブジェクトと同様に、Project（Kubnernetesの名前空間を抽象化したもの）は、パーミッションやリソースを使用・管理するための境界線となります。プロジェクトの作成はデプロイの重要な第一歩です。

. 左上に **管理者向け向け表示** と表記されていることを確認し、左のナビゲーションメニューを使用して、*Virtualization* -> *VirtualMachines* をブラウズします：
+
image::module-01-intro/01_Left_Menu.png[link=self, window=blank, width=100%]
+
[NOTE]
====
*Virtualization* タブが使用できるのは、Red Hat OpenShift Virtualization がインストールされ、適切に設定されている場合のみです。このラボ環境では、インストールと設定はすでに実行されています。
====

. VMを作成する前に、新しいプロジェクトを作成する必要があります。仮想マシンは特定のプロジェクト、つまりネームスペースにデプロイされます。デフォルトでは、いずれかのプロジェクトへのアクセス権限を持たないユーザーは、仮想マシンにアクセスしたり、管理したり、コントロールしたりすることはできません。管理者はすべてのプロジェクトにアクセスできるため、すべての仮想マシンを見ることができますが、一般ユーザーには必要に応じてプロジェクトへのアクセス権を与える必要があります。
+
.. ウィンドウの左上にある *Project: * をクリックし、*Create Project* をクリックします。
+
image::module-01-intro/02_All_Projects.png[link=self, window=blank, width=100%]

.. *Name* フィールドに *vmexamples* と入力してプロジェクトの名前を付け、 *Create* をクリックします。
+
image::module-01-intro/03_Create_Project.png[link=self, window=blank, width=100%]

[[create_vm]]
== Linux仮想マシンの作成

. Virtual Machinesインベントリから *Create VirtualMachine* ボタンをクリックし、ドロップダウンメニューから *From template* を選択します。
+
NOTE: VMはInstanceTypeウィザードから作成することや、カスタムYAML定義を入力して作成することもできますが、今回のラボシナリオでは既存のテンプレートに基づいてVMを作成します。
+
image::module-01-intro/04_Create_VM_Button.png[link=self, window=blank, width=100%]

. ウィザードが表示され、利用可能な定義済みVMテンプレートが表示されます。
+
利用可能なテンプレートのリストを確認すると、 "Source available" を示す青いバッジが付いているものがあることに気づくでしょう。これらは、自動的にダウンロードされ保存されたソースディスクを使用しているテンプレートです。
OpenShift Virtualizationを自社の環境にデプロイする場合、オプションによりこれらのソースディスクが作成されないようにしたり、作成されたものを削除することが可能です。
+
image::module-01-intro/05_Create_VM_Templates.png[link=self, window=blank, width=100%]

. *Fedora VM* タイルを選択すると、ダイアログが開きます。
+
image::module-01-intro/06_Create_VM_Quick.png[link=self, window=blank, width=100%]

. 名前を *fedora01* に変更し、*Quick create VirtualMachine* を押します：
+
image::module-01-intro/07_Create_VM_Quick_Name.png[link=self, window=blank, width=100%]

. 数秒後、VMが *Running* であることがわかります。この間、ストレージプロバイダはテンプレートで指定されたディスクをクローンし、新しく作成された仮想マシンで使用できるようにしています。
この所要時間は、ブートディスクの作成に使用されるストレージプロバイダによって異なります。
+
image::module-01-intro/08_Fedora_Running.png[link=self, window=blank, width=100%]

. VM が作成されたら、プロセスの詳細を見るために *Events* タブを調べます。VMの作成に問題があれば、このタブにも表示されます。
+
image::module-01-intro/09_Fedora_Events.png[link=self, window=blank, width=100%]
+
* はじめに _DataVolume_ が作成されます。_DataVolume_ は VM ディスクの作成を管理するために使われ、VM 作成のフローにおいてクローンやインポートの処理を OpenShift の永続ストレージ上に抽象化しています。
* その後、 _VM_ が起動します。

. *Overview* タブをクリックすると、VMに関連する情報の詳細を表示するプライマリ画面に戻ります。このテンプレートでは、デフォルトでCPUが1、メモリが2GiBであることに注意してください。管理者として、仮想マシンのデフォルト構成をカスタマイズするテンプレートを作成できます。このラボの後半では、カスタム テンプレートの作成について説明します。
+
ソフトウェア定義ネットワーク（SDN）上の仮想マシンのIP アドレスも、ストレージデバイス、システム使用率、仮想マシンをホストするクラスタノードなどの情報とともにこのページに表示されます。デフォルトでは、VM はデフォルトのPod Networkに接続されています。このラボの後半では、高度なネットワーキングオプションと、VM の接続性をカスタマイズする方法を探ります。
+
image::module-01-intro/10_Fedora_Details.png[link=self, window=blank, width=100%] [[admin_vms]] [[admin_vms]] [[admin_vms]]

[[create_win_vm]]
== Windows 仮想マシンの作成

ここでは、Web サーバ上にホストされている ISO イメージを使って Microsoft Windows Server 2019 をインストールします。これは、Web サーバやオブジェクトストレージ、またはクラスタ内の他の PV など、様々な場所にあるディスクをソースとすることができる機能を利用して、VM に OS をインストールする方法の 1 つです。

このプロセスは、VM からテンプレートを作成することで最初の OS のインストール後に効率化できます。テンプレートとして使うゲスト OS を準備する具体的なプロセスは組織によって異なります。あなたの組織ガイドラインと要件に従うようにしてください。

. 左メニューから *Virtualization* -> *VirtualMachines* に移動し、右上のボタンの *Create* をクリックし、*From template* を選択します。
+
. 下にスクロールして、*Microsoft Windows Server 2019 VM* を選択します。
+
image::Create_VM_PVC/27_Windows_2k9_Tile.png[]

. テンプレートに関するデフォルトの構成を示すダイアログが表示されます。
+
image::Create_VM_PVC/28_Windows_2k9_Dialog.png[]

. *Customize VirtualMachine* をクリックして、プロビジョニングで使用するパラメータを指定します。
+
image::Create_VM_PVC/29_Windows_2k9_Parameters.png[]

. ダイアログでは次のように入力します。
.. *Name* : `windows`
.. *Boot from CD* チェックボックスを有効化
.. *Image URI* : `https://bastion.8rpct.azure.redhatworkshops.io/showroom/WIN_en-us.iso`
.. *Disk size* : `6 GiB`
.. *Disk source* : `Blank`
.. *Disk size* : `60 GiB`
.. *Mount Windows drivers disk* チェックボックスを有効化。これは VirtIO 用のドライバを提供するために必要です。

. パラメータを入力したら *Next* を押します。
+
image::Create_VM_PVC/30_Windows_2k9_Parameters_Filled.png[]

. *Scripts* タブに切り替えて、`Sysprep` セクションの *Edit* をクリックします。
+
image::Create_VM_PVC/30_Windows_2k9_Scripts.png[]

. `Autounattend.xml answer file`` のフォームに、以下のコードをコピー&ペーストします。
+
[source,xml,role=copy]
----
<?xml version="1.0" encoding="utf-8"?>
<unattend xmlns="urn:schemas-microsoft-com:unattend" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:schemas-microsoft-com:unattend">
  <settings pass="windowsPE">
    <component name="Microsoft-Windows-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <DiskConfiguration>
        <Disk wcm:action="add">
          <CreatePartitions>
            <CreatePartition wcm:action="add">
              <Order>1</Order>
              <Extend>true</Extend>
              <Type>Primary</Type>
            </CreatePartition>
          </CreatePartitions>
          <ModifyPartitions>
            <ModifyPartition wcm:action="add">
              <Active>true</Active>
              <Format>NTFS</Format>
              <Label>System</Label>
              <Order>1</Order>
              <PartitionID>1</PartitionID>
            </ModifyPartition>
          </ModifyPartitions>
          <DiskID>0</DiskID>
          <WillWipeDisk>true</WillWipeDisk>
        </Disk>
      </DiskConfiguration>
      <ImageInstall>
        <OSImage>
          <InstallFrom>
            <MetaData wcm:action="add">
              <Key>/IMAGE/NAME</Key>
              <Value>Windows Server 2019 SERVERSTANDARD</Value>
            </MetaData>
          </InstallFrom>
          <InstallTo>
            <DiskID>0</DiskID>
            <PartitionID>1</PartitionID>
          </InstallTo>
        </OSImage>
      </ImageInstall>
      <UserData>
        <AcceptEula>true</AcceptEula>
        <FullName>Administrator</FullName>
        <Organization>My Organization</Organization>
      </UserData>
      <EnableFirewall>false</EnableFirewall>
    </component>
    <component name="Microsoft-Windows-International-Core-WinPE" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <SetupUILanguage>
        <UILanguage>en-US</UILanguage>
      </SetupUILanguage>
      <InputLocale>en-US</InputLocale>
      <SystemLocale>en-US</SystemLocale>
      <UILanguage>en-US</UILanguage>
      <UserLocale>en-US</UserLocale>
    </component>
  </settings>
  <settings pass="offlineServicing">
    <component name="Microsoft-Windows-LUA-Settings" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <EnableLUA>false</EnableLUA>
    </component>
  </settings>
  <settings pass="specialize">
    <component name="Microsoft-Windows-Shell-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <AutoLogon>
        <Password>
          <Value>R3dh4t1!</Value>
          <PlainText>true</PlainText>
        </Password>
        <Enabled>true</Enabled>
        <LogonCount>999</LogonCount>
        <Username>Administrator</Username>
      </AutoLogon>
      <OOBE>
        <HideEULAPage>true</HideEULAPage>
        <HideLocalAccountScreen>true</HideLocalAccountScreen>
        <HideOnlineAccountScreens>true</HideOnlineAccountScreens>
        <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>
        <NetworkLocation>Work</NetworkLocation>
        <ProtectYourPC>3</ProtectYourPC>
        <SkipMachineOOBE>true</SkipMachineOOBE>
      </OOBE>
      <UserAccounts>
        <LocalAccounts>
          <LocalAccount wcm:action="add">
            <Description>Local Administrator Account</Description>
            <DisplayName>Administrator</DisplayName>
            <Group>Administrators</Group>
            <Name>Administrator</Name>
          </LocalAccount>
        </LocalAccounts>
      </UserAccounts>
      <TimeZone>Eastern Standard Time</TimeZone>
    </component>
  </settings>
  <settings pass="oobeSystem">
    <component name="Microsoft-Windows-International-Core" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <InputLocale>en-US</InputLocale>
      <SystemLocale>en-US</SystemLocale>
      <UILanguage>en-US</UILanguage>
      <UserLocale>en-US</UserLocale>
    </component>
    <component name="Microsoft-Windows-Shell-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS">
      <AutoLogon>
        <Password>
          <Value>R3dh4t1!</Value>
          <PlainText>true</PlainText>
        </Password>
        <Enabled>true</Enabled>
        <LogonCount>999</LogonCount>
        <Username>Administrator</Username>
      </AutoLogon>
      <OOBE>
        <HideEULAPage>true</HideEULAPage>
        <HideLocalAccountScreen>true</HideLocalAccountScreen>
        <HideOnlineAccountScreens>true</HideOnlineAccountScreens>
        <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>
        <NetworkLocation>Work</NetworkLocation>
        <ProtectYourPC>3</ProtectYourPC>
        <SkipMachineOOBE>true</SkipMachineOOBE>
      </OOBE>
      <UserAccounts>
        <LocalAccounts>
          <LocalAccount wcm:action="add">
            <Description>Local Administrator Account</Description>
            <DisplayName>Administrator</DisplayName>
            <Group>Administrators</Group>
            <Name>Administrator</Name>
          </LocalAccount>
        </LocalAccounts>
      </UserAccounts>
      <TimeZone>Eastern Standard Time</TimeZone>
    </component>
  </settings>
</unattend>
----

. *Save* をクリックします。
+
image::Create_VM_PVC/30_Windows_2k9_Sysprep.png[]

. `Autounattend.xml answer file` が `Available` と表示されていることを確認し、*Create VirtualMachine* を押します。
+
image::Create_VM_PVC/31_Windows_2k9_Create.png[]

. VM は ISO イメージのダウンロード、設定、インスタンスの起動によって、プロビジョニングプロセスを開始します。
+
image::Create_VM_PVC/32_Windows_2k9_Provisioning.png[]

. 数分後、`windows` VM が `Running` ステータスになります。*Console* タブに切り替えると、Windows のインストールプロセスが進んでいることが確認できます。
+
image::Create_VM_PVC/33_Windows_2k9_Console.png[]
+
[NOTE]
Windows のインストールが完了するまで待つ必要はありません。次にセクションに進むことができます。

[[admin_vms]]
== 仮想マシンの管理

仮想マシンの管理と使用は、単に仮想マシンの設定を作成しカスタマイズするだけではありません。プラットフォーム管理者として、リソースのバランスをとり、メンテナンスタスクを実行し、ノードを再構成できるようにVMの状態を制御し、ライブマイグレーションをトリガーできる必要もあります。

. *Configuration* タブをクリックし、仮想マシンのリソースに関する情報を取得します。
+
image::module-01-intro/11_Configuration_Tab_Nav.png[link=self,window=blank,width=100%]
+
7 つのサブタブがあります：
+
image::module-01-intro/12_Configuration_Tab.png[link=self, window=blank, width=100%]
+
* *Details* : このタブは、VMの物理的な機能を1つのパネルに表示します。ここから、CPUやメモリの変更、ホスト名の変更、パススルーデバイスのアタッチ、ブート順の変更など、様々な記述や基本的なハードウェア設定の編集を行うことができます。
* *Storage* : このタブにはシステムに接続されているディスクが一覧表示され、システムに新しいディスクを追加することができます。ゲストがエージェントで設定されている場合、ファイルシステムと使用率が一覧表示されます。ここでは、_ConfigMaps_ 、_Secrets_ および _Service Accounts_ を追加ディスクとしてアタッチできます。これは、仮想マシン内で実行されているアプリケーションに構成情報を渡す場合に便利です。
* *Network* : このタブには、仮想マシンに設定されている現在のネットワークインターフェイスが表示されます。
* *Scheduling* : このタブには、VM を実行する場所と、立ち退きに従う戦略を示す高度な設定オプションが含まれます。このタブは、(アンチ)アフィニティルールの設定、ノードセレクタと許容値の設定、および VM がスケジューリングされるクラスタノードに影響を与えるその他の動作の設定に使用されます。
* *SSH* : このタブでは、設定されたロードバランサー上に SSH サービスを作成するか、機能が有効になっている場合はパブリック SSH キーを注入することで、VMへのリモートアクセスを設定できます。
* *Initial run* : このタブでは、Linuxの場合は _cloud-init_ を、Microsoft Windowsの場合は _sys-prep_ を設定することができます。これには、SSHキーの注入、アプリケーションのインストール、ネットワーク設定など、最初のブート時に実行するコマンドの設定が含まれます。
* *Metadata* : このタブには、仮想マシンに適用されている現在のラベルと注釈が表示されます。これらの値を変更することで、特定の目的のためにマシンにタグを付けたり、マシンを一意に識別して自動化されたワークフローを有効にするのに役立ちます。

. *Storage* タブをクリックして、VMに関連付けられているディスクを一覧表示します:
+
image::module-01-intro/13_Storage_Tab.png[link=self,window=blank,width=100%]
+
このラボ環境では、ディスクに使用されるストレージのソースとタイプを定義するデフォルトのStorageClassには *managed-csi* が設定されています。このストレージは、仮想マシンを実行するために OpenShift Data Foundation (ODF) によって提供されるデフォルトのタイプです。各ストレージプロバイダには、VMディスクをバックアップするストレージの特性を定義する異なるストレージクラスがあります。

. *Network* サブタブをクリックして、VM に接続されているネットワークインターフェイスを調べます：
+
image::module-01-intro/14_Network_Tab.png[link=self,window=blank,width=100%]
+
VM が作成されると、デフォルトで *Pod Networking* ネットワーク上に *masquerade* タイプのインターフェースが作成されます。これは VM を SDN に接続し、VM から OpenShift クラスタ外へのアクセスを提供します。クラスタ内の他の VM や Pod はこのインターフェースを使用して仮想マシンにアクセスできます。
さらに、SDN に接続された VM は、Route を使って外部にアクセスしたり、ロードバランサータイプの Service を使ったり、外部ネットワークに直接アクセスできるように Network Attachment Definition を設定することもできます。

[[vm_state]]
== 仮想マシンの状態の制御

仮想化へのアクセス権限を持つユーザーとして、Webコンソールから仮想マシンを停止、起動、再起動、一時停止、および一時停止解除できます。

. *Overview* タブをクリックすると、VMの概要の画面に戻ります。

. 右上にStop、Restart、Pauseのショートカットボタンがあります。また、*Actions* ドロップダウンメニューも表示されます。
+
image::module-01-intro/15_VM_State_Actions.png[link=self, window=blank, width=100%]
+
.. *Stop* : 仮想マシンのグレースフル・シャットダウンを開始します。
.. *Restart* : 仮想マシンを再起動する信号をオペレーティングシステムに送信します。これが正しく機能するには、ゲスト統合が必要です。
.. *Pause* : プロセスはCPUリソースとI/Oにアクセスすることなくフリーズしますが、ハイパーバイザーレベルでVMが使用するメモリは割り当てられたままになります。

. これらのオプションやその他のオプションにアクセスするには、[*Actions*] メニューをクリックし、ドロップダウンリストで利用可能なオプションを確認します。
+
image::module-01-intro/16_VM_Actions_Menu.png[link=self, window=blank, width=100%]
+
. *Stop* ボタンを押し、仮想マシンが *Stopped* 状態になるまで待ちます。
+
image::module-01-intro/17_VM_Stopped.png[link=self, window=blank, width=100%]
. *Actions* をクリックすると、オプションの *Start* が表示され、オプションの *Restart* と *Pause* はグレーアウトされます。
+
image::module-01-intro/18_VM_Actions_List_Stopped.png[link=self, window=blank, width=100%]

. *Start* をクリックし、*Running* ステータスになるのを待ちます。

. *Actions* メニューまたはショートカットボタンを使用して、*Pause* を実行します。仮想マシンの状態が *Paused* に変わります。
+
image::module-01-intro/19_VM_Actions_Paused.png[link=self, window=blank, width=100%]

. *Actions* メニューの *Unpause* オプション、またはショートカットボタンを使用して、仮想マシンの一時停止を解除します。

[[live_migrate]]
== 仮想マシンのライブマイグレート

このセクションでは、VM をシャットダウンせずに OpenShift ノードから別のノードに移行します。ライブマイグレーションには、VMディスクを移行元と移行先の両方のノードに同時にマウントできるように、*ReadWriteMany* (RWX) ストレージが必要です。OpenShift Virtualizationは、他の仮想化ソリューションとは異なり、多数の異なるVMのための多くのVMディスクを保持する各クラスタメンバーにマウントされたモノリシックデータストアを使用しません。
その代わりに、各VMディスクは必要なときに必要な場所にのみマウントされる独自のボリュームに格納されます。

. *Overview* タブに移動します。クラスタ管理者でログインしている場合、VMが稼働しているノードを確認することができます。
+
[NOTE]
====
下記のスクリーンショットのように、VMが稼働するノードに注目すると、ライブマイグレーション前後でノードが変わっていることがわかります。
====
+
image::module-01-intro/20_VM_Info_Node.png[link=self, window=blank, width=100%]

+
. *Actions* メニューを使用して、 *Migrate* オプションを選択します。
+
image::module-01-intro/21_VM_Dialog_Migrate.png[link=self, window=blank, width=100%]

. VMのステータスが *Migrating* に変更され、数秒後、*Running* ステータスに戻ることを確認します。これでライブマイグレーションが完了しました。
+
image::module-01-intro/22_Migrated.png[link=self, window=blank, width=100%]
+
[NOTE]
====
クラスタ管理者ユーザでVMを実行しているPodを見ると、VMがノード間を移動しているのがわかります。

ワークショップで使用するユーザはクラスタ管理者ではないため、VMの稼働ノードを見ることはできません。下記のスクリーンショットは管理者で表示した例です。
====
+
image::module-01-intro/23_PodLink.png[link=self, window=blank, width=100%]
image::module-01-intro/24_Pod.png[link=self, window=blank, width=100%]

== まとめ

この実習ラボでは、仮想マシンの状態管理タスクを確認し、VM のライブマイグレーションを実行しました。これらの両方は、プラットフォーム管理者として一般的で必要なタスクであり、OpenShift Virtualization で VM を扱うときに利用可能ないくつかの基本的な機能に慣れるための素晴らしい方法です。
