= 既存の仮想マシンの移行

== はじめに

この部分では、 https://access.redhat.com/documentation/en-us/migration_toolkit_for_virtualization/[Migration Toolkit for Virtualization^] (MTV) を使用して、VMware vSphere から OpenShift に仮想マシンをインポートします。
マイグレーション・ツールキットは、2つのマイグレーションモードをサポートしています:

* コールドマイグレーションは、マイグレーションを開始する前にソース仮想マシンの電源を切ります。これはデフォルトの移行タイプです。
* ウォームマイグレーションは、ソース仮想マシンの実行を継続しながらデータをコピーします。データの大部分が移行されるとVMはシャットダウンされ、最終データが移行先にコピーされます。
その後、新しいVMを起動することができるため、VMをホストするアプリケーションのダウンタイムが大幅に短縮されます。

NOTE: マイグレーション・ツールキットは、OperatorHubで利用可能なOperatorを使用してクラスタにデプロイ済みです。

Operatorのインストールおよび設定方法のドキュメントは、 https://access.redhat.com/documentation/en-us/migration_toolkit_for_virtualization/2.9/html/installing_and_using_the_migration_toolkit_for_virtualization/installing-the-operator_mtv[こちら^]を参照してください。

ご自身のニーズに合わせてMigration Toolkit for Virtualizationを設定する方法について詳しく知りたい場合は、以下のリンク先のドキュメントを参照してください:

* https://access.redhat.com/documentation/en-us/migration_toolkit_for_virtualization/2.9/html/installing_and_using_the_migration_toolkit_for_virtualization/prerequisites_mtv#openstack-prerequisites_mtv[OpenStack^]
* https://access.redhat.com/documentation/en-us/migration_toolkit_for_virtualization/2.9/html/installing_and_using_the_migration_toolkit_for_virtualization/prerequisites_mtv#rhv-prerequisites_mtv[Red Hat Virtualization^]
* https://access.redhat.com/documentation/en-us/migration_toolkit_for_virtualization/2.9/html/installing_and_using_the_migration_toolkit_for_virtualization/prerequisites_mtv#vmware-prerequisites_mtv[VMware vSphere^]

目標

* VMware vSphere 環境の調査
* Migration Toolkit for Virtualization (MTV) の構成を確認する。
* 移行計画の作成
* VM を OpenShift Virtualization に移行する

[[prerequisites]]
== 移行に関する前提条件

以下の前提条件がすべての移行に適用されます：

* ISO/CD-ROM ディスクがアンマウントされていること。
* 各 NIC には IPv4 アドレスおよび/または IPv6 アドレスが 1 つずつ含まれている必要があります。
* VM オペレーティング・システムは、 https://access.redhat.com/articles/973163#ocpvirt[OpenShift Virtualization^] のゲストオペレーティングシステムとして使用するために認証され、サポートされている必要があります。
* VM 名には、小文字 (a-z)、数字 (0-9)、またはハイフン (-) のみを含める必要があります。最初と最後の文字は英数字でなければなりません。名前には大文字、スペース、ピリオド(.)、特殊文字を含めることはできません。
* VM 名は、OpenShift Virtualization 環境の既存の VM 名と重複してはなりません。

NOTE: *Migration Toolkit for Virtualization* は、ルールに準拠していない VM に新しい名前を自動的に割り当てます。

このようにすることで、移行をスムーズに進めることができます。

[[migrating_vms]]
== VMwareからの仮想マシンの移行

OpenShiftに移行するための、Windows WebサーバがVMware上にデプロイされています。

この実習ラボでは、コールドマイグレーションを使用して、この仮想マシンを移行します。

=== VMware 環境のレビュー

vSphere上のデータストアやポートグループのようなリソースを、OpenShift の提供する同等の機能となる Storage class および Network Attachment Definitionsにマッピングするプロセスを理解するために、まずは移行元環境の確認を行います。vCenterにログインし、デプロイされているVMを確認します。

. *Workloads* アイコンをクリックして、ナビゲーションツリーを展開し、ワークショップ用のフォルダとその下のVMを確認します。"winweb-xxxxx" という名前のVMがいくつかありますが、"xxxxx" の部分があなたの GUID になっているVMが、あなたのVMです。

NOTE: GUID はラボ環境を払い出した際に表示されたページで確認できます。

画面上部の *VMs* タブをクリックして、あなたのVMの詳細を表示します。
+
image::module-02-mtv/00_Workload_VM_List.png[link=self, window=blank, width=100%]

. *Networks* ビューに変更し、ツリーを展開してVMが使用するポートグループを表示します。名前が *segment-sandbox-xxxxx* であることに注目してください。
+
image::module-02-mtv/01_vSphere_Network.png[link=self, window=blank, width=100%]

. 最後に、*Datastores* ビューを表示して、使用中のデータストアを確認します。
ツリーを展開して環境に存在するデータストアを表示し、オプションで *VMs* サブタブをブラウズして、仮想マシンで使用されている容量を表示します。
+
image::module-02-mtv/02_vSphere_Datastore.png[link=self,window=blank,width=100%]

=== Migration ToolkitのVMwareプロバイダーのレビュー

Migration Toolkit for Virtualization (*MTV*) は、VMware Virtual Disk Development Kit (*VDDK*) SDK を使用して、VMware vSphere から仮想ディスクを転送します。この環境では、VDDKはすでに設定されています。

. OpenShiftの画面に戻り、左メニューの *Migration for Virtualization* -> *Providers* に移動します。
. プロジェクト *openshift-mtv* を選択します。デフォルトでは、ターゲットプラットフォームとして *OpenShift Virtualization* を表す *host* というプロバイダーがあります。
+
image::module-02-mtv/04_MTV_Provider_List.png[link=self, window=blank, width=100%]

. このラボには、*vmware* という名前の VMWare プロバイダーがすでに設定されており、移行元としてマークされています。

=== 移行計画の作成

環境を確認しプロバイダを作成したので、次は移行プランを作成します。このプランでは、VMware vSphere から Red Hat OpenShift Virtualization に移行する VM を選択し、移行を実行する方法を指定します。

. 左メニューの *Migration for Virtualization* -> *Migration Plans* に移動し、*Create Plan* を押します。
+
image::module-02-mtv/14_Create_VMWARE_Plan.png[link=self, window=blank, width=100%]

. 最初に基本的なプランの情報を入力します。以下の値を入力して *Next* をクリックします。

* Plan name: *move-webapp-vmware*
* Plan project: *openshift-mtv*
* Source provider: *vmware*
* Target provider: *host*
* Target project: *vmexamples*
+
NOTE: Plan project は移行プラン自身を保管するプロジェクトで、Target project は移行してくるVMが稼働するプロジェクトです。Target project は事前に作成しておく必要があります。
+
image::module-02-mtv/16_VMware_Source_Provider.png[link=self, window=blank, width=100%]

. 次のページで、移動したいVMを選択します。あなたのVMを指定してください。

* winweb-{GUID}

. *Next* をクリックします。
+
image::module-02-mtv/17_VM_Select_VMWARE_Plan.png[link=self, window=blank, width=100%]

. 次の画面では、*Network map* を設定します。現時点では *Network map* は作成していないので、この場で作成します。*Network map* は、VMware vSphere のポートグループを OpenShift の Network Attachment Definitions にマッピングするために使用されます。以下のように入力して *Next* をクリックします。

* *Use new network map* を選択
* Source network: *segment-sandbox-xxxxx*
* Target network: *default/nad-sandbox-xxxxx*
+
image::module-02-mtv/18_Network_Map.png[link=self, window=blank, width=100%]

. 同様に、*Storage map* を設定します。*Storage map* は、VMware vSphere のデータストアを OpenShift の Storage class にマッピングするために使用されます。以下のように入力して *Next* をクリックします。
+
* *Use new storage map* を選択
* Source network: *workload_share_xxxxx*
* Target network: *ocs-storagecluster-ceph-rbd*
+
image::module-02-mtv/18_Storage_Map.png[link=self, window=blank, width=100%]
+
NOTE: ネットワークマップとストレージマップは、検出された仮想マシンがソースプロバイダ上で現在使用しているネットワークとデータストアを自動的に検出して表示します。

. マイグレーションタイプを選択します。今回は *Cold migration* を選択し、*Next* をクリックします。
+
image::module-02-mtv/18_Migration_Type.PNG[link=self, window=blank, width=100%]

. 次はオプションの設定画面が表示されますが、ここではデフォルトのままにして *Skip to review* をクリックします。プランの内容を確認し、 *Create plan* をクリックします。

. 新しい画面が表示され、移行計画が準備されていることがわかります。しばらくすると、プランが *Ready* になりますので、青い *Start* ボタンをクリックして移行プロセスを開始します。移行を開始するための確認ボックスが表示されますので、*Start* ボタンをクリックしてください。

+
image::module-02-mtv/20_Migration_Plan_Ready.png[link=self, window=blank, width=100%]
+
image::module-02-mtv/21_Confirm_Migrate_Start.png[link=self, window=blank, width=100%]

. *Virtual machines* サブタブで、移行されるVMの名前の横にあるドロップダウン矢印をクリックすると、移行プロセスの段階に関する追加の詳細を表示できます。
+
image::module-02-mtv/23_VMs_Migrating_Details.png[link=self, window=blank, width=100%]
+
[IMPORTANT]
====
このラボ環境では、多くの参加者が同じタスクを並行して実行するため、このタスクの実行速度が実際の環境よりも大幅に遅くなる可能性があります。
このプロセスが完了するまで、しばらくお待ちください。移行が完了したら、ロードショーの他のセクションを続けてもかまいません。

また、Migration Toolkitのドキュメントでは、両システム間に10GbEの接続を推奨していますが、このデモでは利用できません。
====

. 移行が完了すると、選択したVMがOpenShift Virtualization上で起動できるようになっています。
+
image::module-02-mtv/25_Completed_VMWARE_Plan.png[link=self, window=blank, width=100%]


== まとめ

このセクションでは、Migration Toolkit for Virtualization を調べ、それを使って VMware vSphere 環境から OpenShift Virtualization への既存の仮想マシンの移行を支援しました。
Migration Toolkit for Virtualizationの他に、3つの移行ツールキットがあります。
これらを組み合わせることで、組織のニーズに応じて、多くの種類のワークロードをOpenShiftクラスタへの移行やクラスタ内での移動が可能です。

* https://developers.redhat.com/products/mtr/overview[Migration Toolkit for Runtimes^] - Javaアプリケーションのモダナイズと移行を支援し、加速します。
* https://access.redhat.com/documentation/en-us/migration_toolkit_for_applications/[Migration Toolkit for Applications^] - コンテナと Kubernetes への大規模アプリケーションのモダナイズを加速します。
* https://docs.openshift.com/container-platform/4.15/migration_toolkit_for_containers/about-mtc.html[Migration Toolkit for Containers^] - OpenShift クラスタ間でステートフルなアプリケーションのワークロードを移行します。

その他のMigration Toolkitの詳細については、Red Hat アカウントチームにお問い合わせください。
