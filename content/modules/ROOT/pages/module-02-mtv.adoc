= 既存の仮想マシンの移行

== はじめに

この部分では、 https://access.redhat.com/documentation/en-us/migration_toolkit_for_virtualization/[Migration Toolkit for Virtualization^] (MTV) を使用して、VMware vSphere から OpenShift に仮想マシンをインポートします。
マイグレーション・ツールキットは、2つのマイグレーションモードをサポートしています:

* コールドマイグレーションは、マイグレーションを開始する前にソース仮想マシンの電源を切ります。これはデフォルトの移行タイプです。
* ウォームマイグレーションは、ソース仮想マシンの実行を継続しながらデータをコピーします。データの大部分が移行されるとVMはシャットダウンされ、最終データが移行先にコピーされます。
その後、新しいVMを起動することができるため、VMをホストするアプリケーションのダウンタイムが大幅に短縮されます。

NOTE: マイグレーション・ツールキットは、OperatorHubで利用可能なOperatorを使用してクラスタにデプロイ済みです。

Operatorのインストールおよび設定方法のドキュメントは、 https://access.redhat.com/documentation/en-us/migration_toolkit_for_virtualization/2.6/html/installing_and_using_the_migration_toolkit_for_virtualization/installing-the-operator_mtv[こちら^]を参照してください。

ご自身のニーズに合わせてMigration Toolkit for Virtualizationを設定する方法について詳しく知りたい場合は、以下のリンク先のドキュメントを参照してください:

* https://access.redhat.com/documentation/en-us/migration_toolkit_for_virtualization/2.6/html/installing_and_using_the_migration_toolkit_for_virtualization/prerequisites_mtv#openstack-prerequisites_mtv[OpenStack^]
* https://access.redhat.com/documentation/en-us/migration_toolkit_for_virtualization/2.6/html/installing_and_using_the_migration_toolkit_for_virtualization/prerequisites_mtv#rhv-prerequisites_mtv[Red Hat Virtualization^]
* https://access.redhat.com/documentation/en-us/migration_toolkit_for_virtualization/2.6/html/installing_and_using_the_migration_toolkit_for_virtualization/prerequisites_mtv#vmware-prerequisites_mtv[VMware vSphere^]

目標

* VMware vSphere 環境の調査
* Migration Toolkit for Virtualization (MTV) の構成を確認する。
* 移行計画の作成
* VM を OpenShift Virtualization に移行する

[[prerequisites]]
== 移行に関する前提条件

以下の前提条件がすべての移行に適用されます：

* ISO/CD-ROM ディスクがアンマウントされていること。
* 各 NIC には IPv4 アドレスおよび/または IPv6 アドレスが 1 つずつ含まれている必要があります。
* VM オペレーティング・システムは、 https://access.redhat.com/articles/973163#ocpvirt[OpenShift Virtualization^] のゲストオペレーティングシステムとして使用するために認証され、サポートされている必要があります。
* VM 名には、小文字 (a-z)、数字 (0-9)、またはハイフン (-) のみを含める必要があります。最初と最後の文字は英数字でなければなりません。名前には大文字、スペース、ピリオド(.)、特殊文字を含めることはできません。
* VM 名は、OpenShift Virtualization 環境の既存の VM 名と重複してはなりません。

NOTE: *Migration Toolkit for Virtualization* は、ルールに準拠していない VM に新しい名前を自動的に割り当てます。

このようにすることで、移行をスムーズに進めることができます。

[[migrating_vms]]
== VMwareからの仮想マシンの移行

OpenShiftに移行するために、3層のアプリケーションがVMware上にデプロイされています。

アプリケーションは以下の4つの仮想マシンで構成されています:

* Web サーバーにトラフィックをリダイレクトする HAproxy システム1台
* MariaDB データベースを実行している Linux システム1台
* データベースに接続する PHP アプリケーションをホストする IIS を備えた 2 台の Microsoft Windows サーバー

この実習ラボでは、コールド マイグレーションを使用して、4 台の仮想マシンのうち 3 台を移行します。

NOTE: OpenShift は *Service* を使って SDN に接続された VM のネットワークトラフィックとロードバランシングをネイティブに処理するので、HAproxy (ロードバランサ) VM を移行する必要はありません。

=== VMware 環境のレビュー

vSphere上のデータストアやポートグループのようなリソースを、OpenShift の提供する同等の機能となるStorage class および Network Attachment Definitionsにマッピングするプロセスを理解するために、まずは移行元環境の確認を行います。

. VMware vCenter に移動する: https://{vcenter_console}[vCenter Console^].
. *Launch vSphere Client* をクリックします。
. 次の認証情報でログインします：
- *ユーザ:* {vcenter_full_user}
- *パスワード* : {vcenter_password} 
+
[NOTE]
====
始めてvCenterにログインすると、「オブジェクトを表示する権限がありません。」のメッセージが表示されますが、これは正常な動作です。
ログインユーザに環境のトップオブジェクトの表示権限が付与されていないために表示されていますが、以降のオペレーションに影響はありません。
====
+
. デフォルトでは、ナビゲーションツリーの最上部にある *Inventory* ビューに移動します。
*Workloads* アイコンをクリックして、ナビゲーションツリーを展開し、*Roadshow* フォルダとその下の4つのVMを確認します。
画面上部の *VMs* タブをクリックして、VMの詳細を表示します。
+
image::module-02-mtv/00_Workload_VM_List.png[link=self, window=blank, width=100%]

. *Networks* ビューに変更し、ツリーを展開して仮想マシンが使用するポートグループを表示します。名前が *segment-migrating-to-ocpvirt* であることに注目してください。
+
image::module-02-mtv/01_vSphere_Network.png[link=self, window=blank, width=100%]

. 最後に、*Datastores* ビューを表示して、使用中のデータストアを確認します。
ツリーを展開して環境に存在するデータストアを表示し、オプションで *VMs* サブタブをブラウズして、各仮想マシンで使用されている容量を表示します。
+
image::module-02-mtv/02_vSphere_Datastore.png[link=self,window=blank,width=100%]

=== Migration ToolkitのVMwareプロバイダーのレビュー

Migration Toolkit for Virtualization (*MTV*) は、VMware Virtual Disk Development Kit (*VDDK*) SDK を使用して、VMware vSphere から仮想ディスクを転送します。この環境では、VDDKはすでに設定されています。

. OpenShiftの画面に戻り、左メニューの *Migration* -> *Providers for virtualization* に移動します。
. プロジェクト *mtv-{user}* を選択します。
+
image::module-02-mtv/03_MTV_Providers.png[link=self, window=blank, width=100%]
+
[TIP]
====
MTV 2.4以降では、プロジェクト/ネームスペースを認識し、管理者権限を必要としません。VMのインポートをアプリケーションチームやVMユーザーに委任することで、ユーザー自身が自分のペースで移行を行うことができます。

また、インベントリサーバの警告は無視してかまいません。このラボの作業では必要ありません。
====

. デフォルトでは、ターゲットプラットフォームとして *OpenShift Virtualization* を表す *host* というプロバイダーがあります。
+
image::module-02-mtv/04_MTV_Provider_List.png[link=self, window=blank, width=100%]

. このラボには、*vmware* という名前の VMWare プロバイダーがすでに設定されており、移行元としてマークされています。

=== 移行計画の作成

環境を確認しプロバイダを作成したので、次は移行プランを作成します。このプランでは、VMware vSphere から Red Hat OpenShift Virtualization に移行する VM を選択し、移行を実行する方法を指定します。

. 左メニューの *Migration* -> *Plans for virtualization* に移動し、*Create Plan* を押します。
+
image::module-02-mtv/14_Create_VMWARE_Plan.png[link=self, window=blank, width=100%]

. 移行元のプロバイダを選択するよう求められます。*VMware* タイルをクリックします。
+
image::module-02-mtv/16_VMware_Source_Provider.png[link=self, window=blank, width=100%]

. 次のページで、移動したい3つのVMを選択します:

* database-{user}
* winweb01-{user}
* winweb02-{user}

. *Next* をクリックします。
+
image::module-02-mtv/17_VM_Select_VMWARE_Plan.png[link=self, window=blank, width=100%]

. 次の画面では、移行プランの詳細を入力します。いくつかの詳細はすでに入力されていますが、VMが正しいネームスペースに配置され、ネットワークとストレージのオプションが正しくマッピングされるように、少し修正する必要があります。
+
移行プランに以下の値を入力してください：

* Plan name: *move-webapp-vmware*
* Target provider: *host*
* Target namespace: *vmexamples-{user}*
* Network map: *Pod Networking*
* Storage map: *ocs-external-storagecluster-ceph-rbd*
+
NOTE: ネットワークマップとストレージマップの両方が、検出された仮想マシンがソースプロバイダ上で現在使用しているネットワークとデータストアを自動的に検出します。OpenShift 側でそれぞれの値が正しく設定されていることを確認する必要があります。

. *Create migration plan* をクリックします。
+
image::module-02-mtv/18_Create_Migration_Plan.png[link=self, window=blank, width=100%]

. 新しい画面が表示され、移行計画が準備されていることがわかります。
+
image::module-02-mtv/19_Migration_Plan_Unready.png[link=self, window=blank, width=100%]

. しばらくすると、プランが *Ready* になりますので、青い *Start Migration* ボタンをクリックして移行プロセスを開始します。
+
image::module-02-mtv/20_Migration_Plan_Ready.png[link=self, window=blank, width=100%]

. 移行を開始するための確認ボックスが表示されますので、*Start* ボタンをクリックしてください。
+
image::module-02-mtv/21_Confirm_Migrate_Start.png[link=self, window=blank, width=100%]

. 画面中央にプログレスバーが表示され、*0 of 3 VMs migrated* のステータスが表示されます。
+
image::module-02-mtv/22_VMs_Migrating.png[link=self, window=blank, width=100%]

. *0 of 3 VMs migrated* リンクをクリックすると、移行プロセスの詳細ページが表示されます。
+
image::module-02-mtv/23_VMs_Migrating_Details.png[link=self, window=blank, width=100%]
. 移行される各VMの名前の横にあるドロップダウン矢印をクリックすると、移行プロセスの段階に関する追加の詳細を表示できます。
+
image::module-02-mtv/24_VM_Migration_Stages.png[link=self, window=blank, width=100%]
+
[IMPORTANT]
====
シミュレートされたラボ環境では、多くの参加者が同じタスクを並行して実行するため、このタスクの実行速度が実際の環境よりも大幅に遅くなる可能性があります。
このプロセスが完了するまで、しばらくお待ちください。移行が完了したら、ロードショーの他のセクションを続けてもかまいません。

また、Migration Toolkitのドキュメントでは、データセンター間に少なくとも10Gbの接続を推奨していますが、このデモでは利用できません。
====

. 数分後、移行が完了しました。
+
image::module-02-mtv/25_Completed_VMWARE_Plan.png[link=self, window=blank, width=100%]

. これで選択したVMが移行され、OpenShift Virtualization上で起動できるようになりました。

== まとめ

このセクションでは、Migration Toolkit for Virtualization を調べ、それを使って VMware vSphere 環境から OpenShift Virtualization への既存の仮想マシンの移行を支援しました。
Migration Toolkit for Virtualizationの他に、3つの移行ツールキットがあります。
これらを組み合わせることで、組織のニーズに応じて、多くの種類のワークロードをOpenShiftクラスタへの移行やクラスタ内での移動が可能です。

* https://developers.redhat.com/products/mtr/overview[Migration Toolkit for Runtimes^] - Javaアプリケーションのモダナイズと移行を支援し、加速します。
* https://access.redhat.com/documentation/en-us/migration_toolkit_for_applications/[Migration Toolkit for Applications^] - コンテナと Kubernetes への大規模アプリケーションのモダナイズを加速します。
* https://docs.openshift.com/container-platform/4.15/migration_toolkit_for_containers/about-mtc.html[Migration Toolkit for Containers^] - OpenShift クラスタ間でステートフルなアプリケーションのワークロードを移行します。

その他のMigration Toolkitの詳細については、Red Hat アカウントチームにお問い合わせください。
